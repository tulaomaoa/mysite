define(function(require){require("lib/juicer/juicer.min.js");var a=(require("../../common/verify-code.js"),require("./base.js")),c=(require("store"),$("#jsPutqa"));juicer.register("nl2br",function(a){return"string"==typeof a?a.replace(/[\n|\r]/g,"<br>"):""});var h=function(){var a=$("#qa-tpl").html(),c="/course/ajaxqa/id/"+pageInfo.mid+"/t/2?cid="+course_id;$.getJSON(c,function(c){var h=c.data;h.userInfo=OP_CONFIG.userInfo,h.sort="qa",h.panel="panel",h.url=window.location.pathname,h.list=h.list&&h.list.length>3?h.list.slice(0,3):h.list||[],$("#panelQaList").html(juicer(a,h)),twemoji&&twemoji.parse(document.body),$(".course-right-nano").nanoScroller({contentClass:"nano-right-content",sliderClass:"nano-right-slider"})})};h(),a.on("qaPanel/render",h);var v="",g="",b=0,j=0,y=function(){var a,c=$(this);return(a=$.trim(c.val())).length<5?(c.addClass("error").next("p").text("标题不能少于5个字符！"),!1):a.length>255?(c.addClass("error").next("p").text("标题不能大于255个字符！"),!1):void c.removeClass("error").next("p").text("")},C=function(){$(".js-qa-panel-verify-box").addClass("hide").html(""),v=""};UE.getEditor("qa-panel-editor",{initialFrameHeight:160,initialFrameWidth:"100%",autoFloatEnabled:!1,autoClearinitialContent:!0,isMoreInit:!0,initialStyle:"p{line-height:1.5em;font-size:13px;color:#444}",autoHeightEnabled:!1});var E=function(){window.thePlayer&&window.thePlayer.getState&&"PAUSED"!=window.thePlayer.getState()&&"IDLE"!=window.thePlayer.getState()&&thePlayer.pause()};UE.getEditor("qa-panel-editor").addListener("focus",E),$(".qa-panel").on("click",'input[type="text"]',E),c.on("click",".putqa-submit",function(){if("disabled"==$(this).attr("disabled"))return!1;var h=$(this),E={},w=c.find("input"),k=($.trim(w.val()),$("#no-credit")),P=$("#enough-credit"),I=$("#interal-use");if(y.call(w)===!1)return void C();var S=UE.getEditor("qa-panel-editor").getContent();S=$.trim(S);var U=UE.getEditor("qa-panel-editor").getContentTxt();return U=$.trim(U),"请输入问题内容..."==U?($(".qa-panel-editor-error-tip").text("请输入问题内容"),void C()):U.length<5?($(".qa-panel-editor-error-tip").text("内容不能少于5个字！"),void C()):U.length>2e4?($(".qa-panel-editor-error-tip").text("内容长度不能超过20000个字符！建议您分多次发布！"),void C()):(E.content=S,E.cid=course_id,E.mid=pageInfo.mid,E.title=w.val(),E.checkcount=b,"undefined"==typeof v||""==v?($(".js-qa-panel-verify-box").removeClass("hide"),g=new mocaptcha(".js-qa-panel-verify-box",{type:0,success:function(t){v=t,$(".putqa-submit").trigger("click")}}),void $(".js-mocaptcha").append('<span class="js-mocaptcha-close imv2-close"></span>')):(E.token=v,h.attr("disabled","disabled").val("提交中..."),$(".js-panel-error-big-tip").text(""),void $.ajax({url:"/course/ajaxsaveques",type:"post",dataType:"json",data:E,success:function(c){if(0==c.result)I.removeClass("interal-checked"),UE.getEditor("qa-panel-editor").setContent(""),w.val(""),$.prompt("发表成功"),C(),a.emit("qaPanel/render");else{if(1e3==c.result)return C(),$.alert("发布成功，审核通过后才能显示",{callback:function(){UE.getEditor("qa-panel-editor").setContent(""),w.val("")}}),b=0,void(j=0);-105001==c.result?(k.show(),k.find(".cancel-cf").on("click",function(){k.hide()}),C(),b=0,j=0):105002==c.result?(P.show(),$("#interal-cancel").on("click",function(){C(),P.hide()}),I.on("click",function(){b=1,j=1,$(this).addClass("interal-checked"),P.hide(),$(".js-qa-panel-verify-box").addClass("hide").html(""),h.removeAttr("disabled").val("提交"),$(".putqa-submit").trigger("click")})):-103002==c.result?(g.reset(),v=""):($.prompt(c.msg,{icon:"error",timeout:3e3}),C())}},complete:function(){h.removeAttr("disabled").val("提交")}})))})});