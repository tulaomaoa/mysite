define(function(require){require("common");var a=require("../learn/base.js");$.fn.setCursorPosition=function(a){return 0==this.lengh?this:$(this).setSelection(a,a)},$.fn.setSelection=function(a,c){if(0==this.lengh)return this;if(input=this[0],input.createTextRange){var h=input.createTextRange();h.collapse(!0),h.moveEnd("character",c),h.moveStart("character",a),h.select()}else input.setSelectionRange&&(input.focus(),input.setSelectionRange(a,c));return this},$.fn.focusEnd=function(){this.setCursorPosition(this.val().length)};var c={},h=function(){var a={};$.each(c,function(h){c[h]&&c[h].destroy&&c[h].destroy(),a[h]=UE.getEditor("js-editor-"+h,{initialFrameHeight:150,initialFrameWidth:"100%",autoFloatEnabled:!1,autoHeightEnabled:!1,toolbars:[["insertcode","bold","italic","insertunorderedlist","insertorderedlist","emotion"]]})}),c=a},w=function(){var a=$("#js-note-textarea-edit").val();if($.trim(a)){var c=a.replace(/\s*$/,"").length;c>1e3?($(this).addClass("ipt-fake-error"),$("#js-note-limit").addClass("limit-overflow")):($(this).removeClass("ipt-fake-error"),$("#js-note-limit").removeClass("limit-overflow")),$("#js-note-limit").text(c)}else $("#js-note-limit").text($.trim(a).length)};$(document).on("click",".editnote",function(e){window.thePlayer&&window.thePlayer.getState&&"PAUSED"!=window.thePlayer.getState()&&"IDLE"!=window.thePlayer.getState()&&thePlayer.pause(),e.preventDefault();var a=$(this).parents(".js-find-txt"),h=a.attr("uid");if(c[h])a.find(".js-note-main").hide(),a.find(".js-note-editor").show();else{var w=$("#js-editor-"+h).get(0).textContent;c[h]=UE.getEditor("js-editor-"+h,{initialFrameHeight:150,initialFrameWidth:"100%",autoFloatEnabled:!1,autoHeightEnabled:!1,toolbars:[["insertcode","bold","italic","insertunorderedlist","insertorderedlist","emotion"]],onready:function(){twemoji&&c[h].setContent(twemoji.parse(w))}}),a.find(".js-note-main").hide(),a.find(".js-note-editor").show()}}),$("#js-note-input-fake").on("keyup","#js-note-textarea",function(){w()}),$(document).on({focusin:function(){$(this).addClass("space-fake-focus")},focusout:function(){$(this).removeClass("space-fake-focus")},keyup:function(){w()}},"#js-note-input-edit"),$(document).on("click",".js-note-submit",function(e){e.preventDefault();var w=$(this);if(!w.hasClass("submit-loading")){var v=w.closest(".js-find-txt"),y=v.attr("noteId"),g=v.attr("courseId"),j=v.attr("uid"),P='<div class="contain-coverLayer"></div>';c[j]&&(newhtml=c[j].getContent());var S='<div id="js-pop-del" class="pop-deleting"><div class="deleting-bd"></div><div class="deleting-btm">笔记保存成功</div></div>';w.addClass("submit-loading"),w.val("保存中..."),$.ajax({url:"/u/"+OP_CONFIG.userInfo.uid+"/note/"+y,type:"post",data:{course_id:g,content:newhtml},dataType:"json",success:function(v){if(w.removeClass("submit-loading"),0==v.result){$("body").append(S).append(P);var y=/<img.*?(?:>|\/>)/gi;w.closest(".js-find-txt").find(".note-content").html(newhtml.replace(y,"&lt;!--此处有图片--&gt;")),c[j]&&(w.closest(".js-find-txt").find(".js-note-main").show(),w.closest(".js-find-txt").find(".js-note-editor").hide()),a.emit("notePanel/render"),setTimeout(function(){$("#js-pop-del").remove(),$(".contain-coverLayer").remove(),h()},1e3),w.val("提交"),window.thePlayer&&window.thePlayer.getState&&"PAUSED"==window.thePlayer.getState()&&thePlayer.play()}else{var g=$(S);g.find(".deleting-bd").addClass("pop-error").end().find(".deleting-btm").html("笔记保存失败"),$("body").append(g),setTimeout(function(){$("#js-pop-del").remove(),$(".contain-coverLayer").remove()},1e3),layer.msg("保存失败"),window.thePlayer&&window.thePlayer.getState&&"PAUSED"==window.thePlayer.getState()&&thePlayer.play()}},error:function(){w.removeClass("submit-loading"),w.html("提交")}})}}).on("click",".js-note-cancel",function(){var a=$(this),h=a.closest(".js-find-txt"),w=h.attr("uid");c[w]&&(a.closest(".js-find-txt").find(".js-note-main").show(),a.closest(".js-find-txt").find(".js-note-editor").hide())}),$(document).on("click",".delnote",function(e){window.thePlayer&&window.thePlayer.getState&&"PAUSED"!=window.thePlayer.getState()&&"IDLE"!=window.thePlayer.getState()&&thePlayer.pause(),e.preventDefault();var a=$(this).closest(".js-find-txt").attr("noteId"),c=$(".js-find-txt[noteid="+a+"]"),h=($(this).parents(".js-find-txt").find(".report").attr("data"),0);$.confirm("您确定删除这条笔记吗？",{info:"笔记删除将无法恢复",callback:function(){h||(h=1,$.ajax({url:"/u/"+OP_CONFIG.userInfo.uid+"/note/"+a,type:"DELETE",dataType:"json",success:function(a){if(0==a.result){c.remove(),$.prompt("删除成功",{icon:"success"});var w,v;w=$(".js-count-note .got-num"),w.length&&(v=parseInt(w.text(),10),v--,0>=v&&(v=0),w.text(v)),window.thePlayer&&window.thePlayer.getState&&"PAUSED"==window.thePlayer.getState()&&thePlayer.play()}else $.prompt("删除失败去，请重试",{icon:"error"}),h=0,window.thePlayer&&window.thePlayer.getState&&"PAUSED"==window.thePlayer.getState()&&thePlayer.play()}}))}}),$(".popl-no").on("click",function(){$("#js-popl-wrap").remove(),$(".contain-coverLayer").remove(),window.thePlayer&&window.thePlayer.getState&&"PAUSED"==window.thePlayer.getState()&&thePlayer.play()})})});