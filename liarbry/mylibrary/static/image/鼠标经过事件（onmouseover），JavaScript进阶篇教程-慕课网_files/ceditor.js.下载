define(function(require,exports,module){require("ace");var a=require("../../../page/common/verify-code.js"),c={commit:"//program.imooc.com/api/run"},h=pageInfo.mid;h+="-"+Math.round(1e7*Math.random());var C="/course/savecode",v=function(a){this.elems=a,this.editors=[],this.defaults=[],this.fileurl="",this.files=[],this.temp="",this.runNow=!1,this.wHeight=$(window).height(),this.wWidth=$(window).width(),this.initialization()};v.prototype={initialization:function(){var a=this;this.lastFile=null,$.each(a.elems,function(i,c){function t(){a.runNow&&a.runCode()}var h=ace.edit(c),C=$(c).attr("data-lang");("c"===C||"cpp"===C)&&(C="c_cpp"),("oc"===C||"oc_h"===C)&&(C="objectivec"),h.setTheme("ace/theme/tomorrow_night"),h.getSession().setMode("ace/mode/"+C),h.session.setUseWrapMode(!0),h.session.setWrapLimitRange(null,null),h.renderer.setShowPrintMargin(!1),h.setFontSize("14px"),h.lang=C,h.setHighlightActiveLine(!1),h.filename=$(c).attr("data-filename"),a.defaults.push(h.getValue());var v={filename:$(c).attr("data-filename"),lang:$(c).attr("data-lang"),content:$.trim(h.getValue())};a.files.push(v),a.editors.push(h);var g;h.on("change",function(){v.content=$.trim(h.getValue()),a.lastFile=v,g&&clearTimeout(g),g=setTimeout(t,500)})}),("html"==a.files[0].lang||"javascript"==a.files[0].lang)&&($(".aotorun").show(),a.runNow=!1),$("#aotoruncheck").on("click",function(){a.runNow=this.checked}),setTimeout(function(){a.showViewport()},100)},showViewport:function(){var a=$('<iframe name="Consoleframe" id="J_Console" frameborder="0" width="100%" height="100%"></iframe>');a.appendTo($("#viewPort-content"))},runCode:function(a,c,h){c&&(this.callback=c,this.isCommit=a);var C,v=this,g=function(a){a||(a="");var c,h=window.frames.Consoleframe;v.callback&&(v.callback(),v.callback=null),c=h.document?h.document:h.contentDocument,c.open(),c.write(a),c.close()};if("html"==v.files[0].lang){var _="<\\s*link[^>]*?href=(['\"])\\s*",w="\\s*\\1[^>]*?>",y="<\\s*script[^>]*?src=(['\"])\\s*",J="\\s*\\1[\\s\\S]*?<\\/script>";$.each(v.files,function(i,a){var c,h;"html"==a.lang?C=a.content:"css"==a.lang?(c=new RegExp(_+a.filename+w),c.test(C)&&(C=C.replace(c,"<style>"+a.content+"</style>"))):"javascript"==a.lang&&(h=new RegExp(y+a.filename+J),h.test(C)&&(C=C.replace(h,"<script>"+a.content+"</script>")))}),g(C,1)}else g(h,1)},_reset:function(){var a=this,c=$("#reset_mid").attr("rel"),h=$("#reset_step").attr("rel");$.ajax({type:"POST",url:"/course/resetcode",data:{mid:c,step:h},dataType:"json",success:function(c){if(0==c.result){for(var h={},C=c.data.length;C--;)h[c.data[C].filename]=c.data[C];$.each(a.editors,function(i,a){h[a.filename]&&a.setValue(h[a.filename].content)})}}})},commit:function(){var h=["提交正确。","敲的漂亮。","Wow，好厉害。","成功了，让编程来的更猛烈些吧。","不错，慕兄我看好你！","Nice，你这是年薪过百万的节奏啊！","God，你离成神已经不远了！","这你都能通过，无法直视你的双眸。","好，让我们继续一起愉快的玩耍吧。"],v=h.length;$("#J_EditorCommit").on("click","#J_Close,#J_CodeCancel",function(e){e.preventDefault(),$("#J_EditorCommit").animate({height:0},function(){$(this).html("").css({height:"",display:"none"})})});return function(g,_,w){var y=this;this.runCode(1,function(){y.files.length;params.commitfile=y.files,params.uid=OP_CONFIG.userInfo.uid,""!=w&&"undefined"!=typeof w&&(params.verifyCode=w),$.ajax({url:c.commit,type:"POST",dataType:"json",data:params,xhrFields:{withCredentials:"true"},success:function(c){var g;c=c.data,200==c.result?("none"!=$(".js-block").css("display")&&($(".js-block").hide(),$(".js-verify-code-box").hide(),$("#J_VC_Commit").removeClass("submiting").val("提交")),0==pageInfo.next_mid?$("#J_EditorCommit").html(pageInfo.isfinished?'<p class="success"><span class="status icon-tick2"></span> 恭喜你,通过了本次课程 <a class="operate suColor" id="J_CodeNext" href="'+__nexthref+'">返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>':'<p class="success"><span class="status icon-tick2"></span>代码提交成功，课程持续更新中，敬请期待！<a class="operate suColor" id="J_CodeNext" href="'+__nexthref+'">返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>'):(g="1"==$("#J_CodeLang").data("regular")?h[Math.floor(Math.random()*v)]:"该节编程练习不验证代码，你可以各种尝试，或继续学习",$("#J_EditorCommit").html('<p class="success"><span class="status icon-tick2"></span>'+g+'<a class="operate suColor" id="J_CodeNext" href="'+__nexthref+'">下一节</a>吧。</p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>')),$("#J_Commit").removeClass("submiting").html("提交"),$.post(C,{mid:pageInfo.mid,step:pageInfo.step,lang:params.lang,files:params.commitfile,key:c.key},function(a){_&&_(a)},"json")):429==c.result?($(".js-block").height($(document).height()).show(),$(".js-verify-code-box").show(),a.renderVerifyCodeBlock(".js-verify-code-box .verify-code","//program.imooc.com/api/verifycode"),$("#J_VC_Commit").removeClass("submiting").val("提交")):430==c.result?($(".js-verify-code-box").find(".js-verify-code-tip").html("验证码输入错误，请重试！").show(),$(".js-verify-code-box .verify-code").find(".verify-code-ipt").val(""),$(".js-verify-code-box").find(".js-verify-refresh").click(),$("#J_VC_Commit").removeClass("submiting").val("提交")):("none"!=$(".js-block").css("display")&&($(".js-block").hide(),$(".js-verify-code-box").hide(),$("#J_VC_Commit").removeClass("submiting").val("提交")),$("#J_Commit").removeClass("submiting").html("提交"),$("#J_EditorCommit").html(0==pageInfo.next_mid?'<p class="fail"><span class="status icon-point"></span>'+c.msg+' <a class="operate faColor" id="J_CodeCancel">再试试</a>! <a class="operate suColor" id="J_CodeNext" href="'+__nexthref+'"> 返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>':'<p class="fail"><span class="status icon-point"></span>'+c.msg+'，<a class="operate faColor" id="J_CodeCancel">再试试</a>！直接进入<a class="operate suColor" href="'+__nexthref+'">下一节</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>')),c.runResult&&c.runResult.length>0&&y.runCode(null,null,c.runResult),$("#J_EditorCommit").fadeIn()},complete:function(){$("#J_VC_Commit").removeClass("submiting").val("提交"),$("#J_Commit").removeClass("submiting").html("提交")}})})}}()},module.exports={init:function(a){return new v(a)}}});