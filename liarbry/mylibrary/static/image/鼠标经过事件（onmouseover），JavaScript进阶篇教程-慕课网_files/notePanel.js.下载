define(function(require){require("lib/juicer/juicer.min.js"),juicer.register("getScriptHtml",function(a,c,h){return'<script type="text/plain" id="js-editor-'+c+"_"+h+'">'+a+"</script>"});var a=(require("../../common/verify-code.js"),require("./base.js")),c=(require("store"),require("./note.js")),h=require("/static/component/base/util/picViewer"),g=function(a){var c=a.toString(16);return c.length>5?c:5==c.length?"l"+c:(c=$.md5(c)+"l"+c,c.substr(-6))},v=$("#jsPutNote"),j=function(){var a=$("#note-tpl").html(),h="/course/mynote",v={mid:pageInfo.mid,r:Math.random(),sort:"last",page:1,ower:"my"};$.getJSON(h,v,function(h){var v=h.data||{};v.userInfo=OP_CONFIG.userInfo,v.sort="note",v.panel="panel",v.url=window.location.href,v.flag="right",v.list=v.list||[],$.each(v.list,function(a,c){c._url=g(parseInt(c.id))}),$("#panelNoteList").html(juicer(a,v)),twemoji&&twemoji.parse(document.body),c.resetOptionBtn("#panelNoteList"),$(".course-right-nano").nanoScroller({contentClass:"nano-right-content",sliderClass:"nano-right-slider"})})};a.on("notePanel/render",j),j(),$(document).on("click",".js-shot-pic",function(){$(this).hasClass("on")?$(this).removeClass("on"):$(this).addClass("on")});var y=function(){$(".js-note-panel-verify-box").addClass("hide").html(""),token=""};UE.getEditor("note-panel-editor",{initialFrameHeight:160,initialFrameWidth:"100%",autoFloatEnabled:!1,autoClearinitialContent:!0,isMoreInit:!0,initialStyle:"p{line-height:1.5em;font-size:13px;color:#444}",autoHeightEnabled:!1});var C=function(){window.thePlayer&&window.thePlayer.getState&&"PAUSED"!=window.thePlayer.getState()&&"IDLE"!=window.thePlayer.getState()&&thePlayer.pause()};UE.getEditor("note-panel-editor").addListener("focus",C),v.on("click",".putnote-submit",function(){var c=$(this),h={};if(!c.hasClass("submit-loading")){var g=UE.getEditor("note-panel-editor").getContent();g=$.trim(g);var v=UE.getEditor("note-panel-editor").getContentTxt(),j=$.trim(v).length;if("请输入笔记内容..."==v)return $(".note-panel-error-tip").text("请输入笔记内容"),void y();if(5>j)return $(".note-panel-error-tip").text("内容不能少于5个字！"),void y();if(j>2e4)return $(".note-panel-error-tip").text("内容长度不能超过20000个字符！建议您分多次发布！"),void y();if($(".note-panel-error-tip").text(""),h.content=g,h.mid=pageInfo.mid,h.picture_url="",h.picture_time=0,-1!=window.location.href.indexOf("video")&&$(".js-shot-pic").hasClass("on")){if(!$(".J_next-box").hasClass("hide")||$(".mocoplayer-error").length)return void $.prompt("请在视频播放时截图！",{icon:"error"});thePlayer.getCurrentTime&&(h.picture_time=Math.round(thePlayer.getCurrentTime()))}if(-1!=window.location.href.indexOf("code")&&$(".js-shot-pic").hasClass("on")){var C=$("#J_EditorTabs").find(".editor-item"),w=require("ceditor"),w=w.init(C),b=[];$.each(w.files,function(a,c){var h={filename:c.filename,lang:c.lang,content:c.content};b.push(h)}),h.lang=$("#J_CodeLang").attr("data-lang"),h.files=b}"undefined"!=typeof token&&""!=token&&(h.token=token),c.addClass("submit-loading").val("正在保存..."),$.ajax({url:"/course/addnote",type:"post",dataType:"json",data:h,success:function(c){0==c.result?(y(),$.prompt("发布成功",{icon:"success"}),UE.getEditor("note-panel-editor").setContent(""),a.emit("notePanel/render")):1==c.data&&-1==c.result?(y(),$(".js-note-panel-verify-box").removeClass("hide"),moVerify=new mocaptcha(".js-note-panel-verify-box",{type:0,success:function(t){token=t,$(".putnote-submit").trigger("click")}}),$(".js-mocaptcha").append('<span class="js-mocaptcha-close imv2-close"></span>')):-103002==c.result?(moVerify.reset(),token=""):($.prompt(c.msg,{icon:"error"}),y())},complete:function(){$(".putnote-submit").removeClass("submit-loading").val("保存")},error:function(){$.prompt("发布失败",{icon:"error"}),y()}})}}),$(".note-panel").on("click",".js-catch-pic",function(){var a=$(this).data("src");h.create(a)})});