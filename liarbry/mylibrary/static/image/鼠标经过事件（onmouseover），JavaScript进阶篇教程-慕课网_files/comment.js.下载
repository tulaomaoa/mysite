define(function(require){var a=require("store"),c=require("./base.js"),h=null,v='<div id="js-pub-container" class="clearfix">                    <div class="pub-input-box clearfix">                        <div class="wgt-ipt-wrap pub-editor-wrap l" id="js-pl-input-fake">                            <textarea id="js-pl-textarea" class="" placeholder="扯淡、吐槽、表扬、鼓励……想说啥就说啥！"></textarea>                            <span class="num-limit"><span id="js-pl-limit">0</span>/300</span>                        </div>                    </div>                    <div id="pub-btm" class="pub-btm pub-comment clearfix">                        <div class="captcha-verify-box js-verify-box hide"></div>                        <input type="button" id="js-pl-submit" class="moco-btn moco-btn-red moco-btn-lg r" value="发表评论">                        <span class="errortip r">您还没有填写内容！</span>                    </div>                </div>';if(0==$(".empty-holder").length){var j=$(".mod-post").find(".post-row"),b=[];$(j).each(function(a){b.push($(j[a]).attr("id"))});var k=b.join(",");$.ajax({url:"/course/ajaxusercommentsstatus",data:{ids:k},type:"GET",dataType:"json",success:function(a){if(0==a.result){var c=a.data;""!=c&&$(b).each(function(a){$(c).each(function(i){if(b[a]==c[i].comment_id){var h=$(j).eq(a).find(".js-pl-praise"),v=c[i].support_num;h.attr("title","取消赞").addClass("on"),h.find("span").addClass("on"),h.find("em").text(v)}})})}}})}$(document).on("click",".js-mocaptcha-close",function(){$(".captcha-verify-box").addClass("hide").html(""),token=""});var w=function(){$(".js-verify-box").addClass("hide").html(""),token=""},y="",C=function(a){var h,v=$("#js-pl-submit"),j=$("#js-user-mp"),b=$("#js-pub-container").find(".errortip"),k={};if(!v.hasClass("commentLoading")){if(h=$.trim($("#js-pl-textarea").val()),h.length<5)return b.text("内容不能少于5个字符！").show(),void w();if(h.length>300)return b.text("内容不能大于300个字符！").show(),void w();if(b.hide(),j.length&&+j.text()<50)return b.text("您的经验值未满50，不能发表评论！").show(),w(),!1;var C={content:h,cid:course_id,mid:pageInfo.mid};$.extend(C,k),a&&(C.checked=1),"undefined"!=typeof token&&""!=token&&(C.token=token),v.addClass("commentLoading").val("发布中..."),$.ajax({url:"/course/docomment",type:"post",dataType:"json",data:C,success:function(a){if(-103008==a.result){var h=$("#maybe-wenda");h.show().addClass("show"),w()}else{if(1e3==a.result)return $.alert("发布成功，审核通过后才能显示",{callback:function(){g.hidePublish()}}),void w();0===a.result?($.prompt("发表成功"),c.emit("commentPanel/render"),setTimeout(function(){g.hidePublish()},2e3)):-1==a.result?($(".js-verify-box").removeClass("hide"),y=new mocaptcha(".js-verify-box",{type:0,success:function(t){token=t,$("#js-pl-submit").trigger("click")},error:function(){}}),$(".js-mocaptcha").append('<span class="js-mocaptcha-close imv2-close"></span>')):-103002==a.result?(y.reset(),token=""):($.prompt(a.msg,{icon:"error"}),w())}},complete:function(){v.removeClass("commentLoading").val("发表评论")}})}},g={praiseClick:function(a){$praise=a.find("em"),$.ajax({url:"/course/commentsupport",data:{id:a.attr("data-id")},type:"GET",dataType:"json",success:function(c){if(0==c.result){var h=parseInt($praise.text());$praise.text(h+1),a.addClass("on"),a.find("span").addClass("on praise-anim"),a.attr("title","取消赞")}}})},praiseCancel:function(a){$praise=a.find("em"),$.ajax({url:"/course/commentsupport?cancel",data:{id:a.attr("data-id")},type:"POST",dataType:"json",success:function(c){if(0==c.result){var h=parseInt($praise.text());$praise.text(h-1),a.removeClass("on"),a.find("span").attr("class","icon-thumb-revert"),a.attr("title","赞")}}})},showPublish:function(){window.thePlayer&&window.thePlayer.getState&&"PAUSED"!=window.thePlayer.getState()&&"IDLE"!=window.thePlayer.getState()&&thePlayer.pause(),h=$.dialog(v,{title:"我要评论",width:560,height:260,modal:!0,callback:function(){$(".js-modal-close").click()}})},hidePublish:function(){h.hide()}};$("#wenda-ok").on("click",function(){a.set("maybewenda_content",$.trim($("#js-pl-textarea").val())),$("#maybe-wenda").removeClass("show").slideUp("fast"),$(".js-qa-btn").click()}),$("#wenda-no").on("click",function(){C(!0),$("#maybe-wenda").removeClass("show").slideUp("fast")}),$(document).on("click",".js-pl-praise",function(e){if(e.preventDefault(),!OP_CONFIG.userInfo)return void require.async("login_sns",function(a){a.init()});var a=$(this);a.hasClass("on")?g.praiseCancel(a):g.praiseClick(a)}).on("click","#js-pl-submit",function(){C(!1)}).on("focusin","#js-pl-input-fake",function(){$(this).addClass("ipt-fake-focus"),$(".pub-editor-wrap").next(".errortip").hide()}).on("focusout","#js-pl-input-fake",function(){$(this).removeClass("ipt-fake-focus")}).on("keyup","#js-pl-input-fake",function(){var a=$.trim($("#js-pl-textarea").val()).length;a>300?$(this).addClass("ipt-fake-error").find("#js-pl-limit").addClass("limit-overflow"):$(this).removeClass("ipt-fake-error").find("#js-pl-limit").removeClass("limit-overflow"),$("#js-pl-limit").text(a)}).on("click",".js-comment-btn",g.showPublish)});